(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function o(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerPolicy&&(i.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?i.credentials="include":e.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(e){if(e.ep)return;e.ep=!0;const i=o(e);fetch(e.href,i)}})();class S{constructor(){this.keys={}}keyDown(t){this.keys[t.key]=!0}keyUp(t){this.keys[t.key]=!1}isKeyDown(t){return!!this.keys[t]}}class E{constructor(t,o,s,e,i){this.image=t,this.frameWidth=o,this.frameHeight=s,this.frameCount=e,this.frameRate=i,this.currentFrame=0,this.elapsedTime=0}update(t){this.elapsedTime+=t;const o=1/this.frameRate;for(;this.elapsedTime>=o;)this.currentFrame=(this.currentFrame+1)%this.frameCount,this.elapsedTime-=o}draw(t,o,s,e=1){const i=this.currentFrame*this.frameWidth;t.drawImage(this.image,i,0,this.frameWidth,this.frameHeight,o,s,this.frameWidth*e,this.frameHeight*e)}}class P{constructor(t,o,s){this.moveCooldown=30,this.lastMoveTime=0,this.moveSpeed=.16,this.zoom=1.5,this.currentDirection="down",this.gridX=t,this.gridY=o;const e=32,i=32,n=4,h=6;this.animations={up:new E(s.player_up,e,i,n,h),down:new E(s.player_down,e,i,n,h),left:new E(s.player_left,e,i,n,h),right:new E(s.player_right,e,i,n,h),upleft:new E(s.player_upleft,e,i,n,h),upright:new E(s.player_upright,e,i,n,h),downleft:new E(s.player_downleft,e,i,n,h),downright:new E(s.player_downright,e,i,n,h)},this.currentAnimation=this.animations[this.currentDirection]}update(t,o,s,e){let i=null;t.isKeyDown("ArrowUp")&&t.isKeyDown("ArrowLeft")?i="upleft":t.isKeyDown("ArrowUp")&&t.isKeyDown("ArrowRight")?i="upright":t.isKeyDown("ArrowDown")&&t.isKeyDown("ArrowLeft")?i="downleft":t.isKeyDown("ArrowDown")&&t.isKeyDown("ArrowRight")?i="downright":t.isKeyDown("ArrowUp")?i="up":t.isKeyDown("ArrowDown")?i="down":t.isKeyDown("ArrowLeft")?i="left":t.isKeyDown("ArrowRight")&&(i="right"),i&&i!==this.currentDirection&&(this.currentDirection=i,this.currentAnimation=this.animations[this.currentDirection]);const n=t.isKeyDown("ArrowUp")||t.isKeyDown("ArrowDown")||t.isKeyDown("ArrowLeft")||t.isKeyDown("ArrowRight");e!==void 0&&(n?this.currentAnimation.update(e):(this.currentAnimation.currentFrame=0,this.currentAnimation.elapsedTime=0));const h=performance.now();if(h-this.lastMoveTime<this.moveCooldown)return;let f=0,d=0;if(t.isKeyDown("ArrowUp")&&(f+=-1,d+=-1),t.isKeyDown("ArrowDown")&&(f+=1,d+=1),t.isKeyDown("ArrowLeft")&&(f+=-1,d+=1),t.isKeyDown("ArrowRight")&&(f+=1,d+=-1),f===0&&d===0)return;const c=Math.sqrt(f*f+d*d),p=f/c,u=d/c,r=this.moveSpeed,a=1/3,g=o.map[0].length-2,w=o.map.length-2,y=this.gridX+p*r,x=this.gridY+u*r;let m=this.gridX,v=this.gridY;const b={x:y,y:this.gridY,width:1,height:1};let A=!1;for(const D of s??[])if(D!==this&&"getBounds"in D&&typeof D.getBounds=="function"){const C=D.getBounds();if(this.isColliding(b,C)){A=!0;break}}A||(m=y);const k=A?this.gridY+u*r*a:x,N={x:m,y:k,width:1,height:1};let H=!1;for(const D of s??[])if(D!==this&&"getBounds"in D&&typeof D.getBounds=="function"){const C=D.getBounds();if(this.isColliding(N,C)){H=!0;break}}H||(v=k),m=Math.max(0,Math.min(m,g)),v=Math.max(0,Math.min(v,w)),this.gridX=m,this.gridY=v,this.lastMoveTime=h}render(t,o,s){const e=t.canvas.width/2,i=50,n=e+(this.gridX-this.gridY)*(o/2),h=i+(this.gridX+this.gridY)*(s/2);t.save();const f=this.currentAnimation.frameWidth+15,d=this.currentAnimation.frameHeight+5,c=n-f/2,p=h+s/2-d;this.currentAnimation.draw(t,c,p,this.zoom),t.restore()}isColliding(t,o){return t.x<o.x+o.width&&t.x+t.width>o.x&&t.y<o.y+o.height&&t.y+t.height>o.y}getBounds(){return{x:this.gridX,y:this.gridY,width:1,height:1}}}let K=0;const G=1e3;class z{constructor(t,o,s,e=0,i=0,n=0){this.width=64,this.height=64,this.transition=null,this.onPlayerEnter=null,this.gridX=t,this.gridY=o,this.image=s[e],this.alwaysOnTop=e===2||e===3,this.alwaysOnBottom=e===0||e===1,this.position=e,this.roomId=i,this.connectionId=n}setTransition(t,o){this.transition={targetRoomId:t,targetDoorPosition:o}}update(t,o,s,e){if(s){const i=s.find(n=>n instanceof P);if(i){const n=i,h=Math.abs(n.gridX-this.gridX),f=Math.abs(n.gridY-this.gridY),d=performance.now(),c=d-K>G;h<=.8&&f<=.8&&this.transition&&c&&(K=d,this.onPlayerEnter&&this.onPlayerEnter(this.transition.targetRoomId,this.transition.targetDoorPosition))}}}getOppositePosition(){switch(this.position){case 0:return 3;case 1:return 2;case 2:return 1;case 3:return 0;default:return 0}}getSpawnPosition(){let t=this.gridX,o=this.gridY;switch(this.position){case 0:t+=.5,o+=1.5;break;case 1:t+=1.5,o+=0;break;case 2:t-=1.5,o-=0;break;case 3:t+=.5,o-=1.5;break}return{x:t,y:o}}render(t,o,s){let e=0,i=0;switch(this.position){case 0:e=t.canvas.width/2+10,i=47;break;case 1:e=t.canvas.width/2+5,i=35;break;case 2:e=t.canvas.width/2+5,i=48;break;case 3:e=t.canvas.width/2,i=49;break;default:e=t.canvas.width/2,i=50;break}const n=e+(this.gridX-this.gridY)*(o/2),h=i+(this.gridX+this.gridY)*(s/2);t.drawImage(this.image,n-this.width/2,h-this.height/2,this.width,this.height)}}class q{constructor(t=[]){this.entities=t}addEntity(t){Array.isArray(t)?this.entities.push(...t):this.entities.push(t)}getEntities(){return this.entities}update(t,o,s){for(const e of this.entities)e instanceof P?e.update(t,o,this.entities,s):e.update(t,o,this.entities)}render(t,o,s){this.entities.sort((e,i)=>{if(e.alwaysOnTop&&!i.alwaysOnTop)return 1;if(!e.alwaysOnTop&&i.alwaysOnTop||e.alwaysOnBottom&&!i.alwaysOnBottom)return-1;if(!e.alwaysOnBottom&&i.alwaysOnBottom)return 1;const n=e.gridX+e.gridY,h=i.gridX+i.gridY;return n-h}),this.entities.forEach(e=>{e.render(t,o,s)})}}class ${constructor(t,o,s){this.tileWidth=32,this.tileHeight=32,this.gridX=t,this.gridY=o;const e=Math.floor(Math.random()*s.length);this.image=s[e]}update(t,o){}getBounds(){return{x:this.gridX,y:this.gridY,width:.5,height:.5}}render(t,o,s){const e=t.canvas.width/2,i=50,n=e+(this.gridX-this.gridY)*(o/2),h=i+(this.gridX+this.gridY)*(s/2);t.drawImage(this.image,n-this.tileWidth/2,h-this.tileHeight/2,this.tileWidth,this.tileHeight)}}class j{constructor(t,o){this.tileWidth=40,this.tileHeight=20,this.images=t,this.doors=o,this.map=this.generateMap()}generateMap(){var h;const s=[],e={x:Math.floor(10),y:Math.floor(10)-1},i=[{x:9,y:0},{x:0,y:8},{x:18,y:9},{x:9,y:18}],n=(h=this.doors)==null?void 0:h.map(f=>i[f]);for(let f=0;f<20;f++){const d=[];for(let c=0;c<20;c++){let p;const u=f===19&&c===0,r=f===0&&c===19,a=f===19,g=c===19,w=f===19&&c===19;if(u)p="edgeTopLeft";else if(r)p="edgeTopRight";else if(w)p="edgeCenter";else if(a)p="edgeLeft";else if(g)p="edgeRight";else{const y=["grass1","grass2"];let x=!1;for(const m of n){const v=Math.min(e.x,m.x),b=Math.max(e.x,m.x),A=Math.min(e.y,m.y),k=Math.max(e.y,m.y);if(c>=v&&c<=b&&f>=A&&f<=k){x=!0;break}}x?p=Math.random()<.9?"grass3":y[Math.floor(Math.random()*y.length)]:p=y[Math.floor(Math.random()*y.length)]}d.push(p)}s.push(d)}return s}render(t){const o=t.canvas.width/2,s=50;for(let e=0;e<this.map.length;e++)for(let i=0;i<this.map[e].length;i++){const n=this.map[e][i],h=this.images[n];if(!h)continue;const f=o+(i-e)*(this.tileWidth/2),d=s+(i+e)*(this.tileHeight/2);t.drawImage(h,f-this.tileWidth/2,d,this.tileWidth,this.tileHeight)}}}const J=l=>{let s=1;const e=Array.from({length:9},()=>Array(9).fill(0)),i=(r,a)=>r>=0&&r<9&&a>=0&&a<9,n=(r,a)=>[[0,1],[0,-1],[1,0],[-1,0]].some(([w,y])=>{const x=r+w,m=a+y;return i(x,m)&&e[x][m]!=0});let h=0;const f=Math.floor(9/2),d=Math.floor(9/2);e[f][d]=s,s++,h++;const c=[];for(let r=0;r<9;r++)for(let a=0;a<9;a++)c.push({r,c:a});const p=r=>{for(let a=r.length-1;a>0;a--){const g=Math.floor(Math.random()*(a+1));[r[a],r[g]]=[r[g],r[a]]}return r};for(;h<l;){let r=!1;const a=[];for(const{r:g,c:w}of p(c))if(e[g][w]===0&&n(g,w)){a.push({r:g,c:w});let y=.1;if((w>=2&&e[g][w-1]!=0&&e[g][w-2]!=0||w<=6&&e[g][w+1]!=0&&e[g][w+2]!=0||g>=2&&e[g-1][w]!=0&&e[g-2][w]!=0||g<=6&&e[g+1][w]!=0&&e[g+2][w]!=0)&&(y=.7),Math.random()<y&&(e[g][w]=s,h++,s++,r=!0,h>=l))break}if(!r&&a.length>0){const g=a[Math.floor(Math.random()*a.length)];e[g.r][g.c]=s,h++,s++,r=!0}if(!r)break}const u=[];for(let r=0;r<9;r++)for(let a=0;a<9;a++)if(e[r][a]!=0){const g=[];r>0&&e[r-1][a]!==0&&g.push({door:0,connection:e[r-1][a]}),a>0&&e[r][a-1]!==0&&g.push({door:1,connection:e[r][a-1]}),a<8&&e[r][a+1]!==0&&g.push({door:2,connection:e[r][a+1]}),r<8&&e[r+1][a]!==0&&g.push({door:3,connection:e[r+1][a]}),u.push({doors:g,id:e[r][a]})}return{layout:u.sort((r,a)=>r.id-a.id),map:e}},M={UPRIGHT:0,UPLEFT:1,DOWNRIGHT:2,DOWNLEFT:3};let X=0;const T=new Map;let Y=null;const B=[];function Q(l){B.push(l)}function I(){return T.get(X)||null}function V(l,t){if(!Y||!T.has(l))return;const o=T.get(X);o.entities.entities=o.entities.entities.filter(n=>!(n instanceof P)),X=l;const s=T.get(l),e=s.doors.find(n=>n.position===t);if(!e)return;const i=e.getSpawnPosition();Y.gridX=i.x,Y.gridY=i.y,s.entities.addEntity(Y);for(const n of B)n({tileMap:s.tileMap,entities:s.entities})}function Z(l,t,o){const s=new j(t.tiles,o),e=new q([]),i=[],n=[t.doors.door_upright,t.doors.door_upleft,t.doors.door_downright,t.doors.door_downleft];o.forEach(d=>{let c=9,p=9;switch(d){case M.UPRIGHT:c=9,p=0;break;case M.UPLEFT:c=0,p=9;break;case M.DOWNRIGHT:c=18,p=9;break;case M.DOWNLEFT:c=9,p=18;break}const u=new z(c,p,n,d,l);u.onPlayerEnter=V,i.push(u),e.addEntity(u)});const h=[],f=Math.floor(Math.random()*3);for(let d=0;d<f;d++){let c,p,u=!1;for(;!u;){if(c=2+Math.floor(Math.random()*17),p=2+Math.floor(Math.random()*17),u=!0,Math.abs(c-9)<3&&Math.abs(p-9)<3){u=!1;continue}for(const a of i)if(Math.abs(c-a.gridX)<3&&Math.abs(p-a.gridY)<3){u=!1;break}}const r=new $(c,p,[t.rocks.rock1]);h.push(r)}return h.length>0&&e.addEntity(h),{id:l,tileMap:s,entities:e,doors:i}}function tt(l,t){l.setTransition(t.roomId,t.position),t.setTransition(l.roomId,l.position)}function et(l){switch(l){case M.UPRIGHT:return M.DOWNLEFT;case M.UPLEFT:return M.DOWNRIGHT;case M.DOWNRIGHT:return M.UPLEFT;case M.DOWNLEFT:return M.UPRIGHT;default:return 0}}function it(l){const{layout:t,map:o}=J(10);T.clear(),Y=new P(9,9,l.player);for(const s of t){const e=s.doors.map(n=>n.door),i=Z(s.id,l,e);T.set(s.id,i),s.id===1&&(i.entities.addEntity(Y),X=1)}for(const s of t){const e=T.get(s.id);if(e)for(const i of s.doors){const n=T.get(i.connection);if(!n)continue;const h=e.doors.find(c=>c.position===i.door),f=et(i.door),d=n.doors.find(c=>c.position===f);h&&d&&tt(h,d)}}return{tileMap:T.get(X).tileMap,entities:T.get(X).entities,miniMap:o}}class st{constructor(t,o){this.lastTime=0,this.input=new S,this.miniMap=[],this.transitionEffect={active:!1,alpha:0,fadingIn:!0,duration:300,startTime:0},this.ctx=t,this.assets=o;const{tileMap:s,entities:e,miniMap:i}=it(o);this.tileMap=s,this.entities=e,this.miniMap=i,Q(n=>{this.handleRoomChange(n)}),window.addEventListener("keydown",n=>this.input.keyDown(n)),window.addEventListener("keyup",n=>this.input.keyUp(n))}handleRoomChange(t){this.transitionEffect.active=!0,this.transitionEffect.fadingIn=!1,this.transitionEffect.alpha=0,this.transitionEffect.startTime=performance.now(),setTimeout(()=>{this.tileMap=t.tileMap,this.entities=t.entities,this.transitionEffect.fadingIn=!0},this.transitionEffect.duration/2)}start(){requestAnimationFrame(t=>this.loop(t))}loop(t){const o=(t-this.lastTime)/1e3;this.lastTime=t,this.update(o,t),this.render(),requestAnimationFrame(s=>this.loop(s))}update(t,o){if(this.transitionEffect.active){const e=o-this.transitionEffect.startTime,i=Math.min(e/this.transitionEffect.duration,1);this.transitionEffect.fadingIn?(this.transitionEffect.alpha=1-i,i>=1&&(this.transitionEffect.active=!1)):this.transitionEffect.alpha=i}(!this.transitionEffect.active||this.transitionEffect.alpha<.9)&&this.entities.update(this.input,this.tileMap,t);const s=I();s&&(this.tileMap!==s.tileMap||this.entities!==s.entities)&&(this.tileMap=s.tileMap,this.entities=s.entities)}renderMiniMap(){var f;const s=Math.min(100/this.miniMap[0].length,100/this.miniMap.length),e=s*2,i=s,n=this.ctx.canvas.width-100,h=40;for(let d=0;d<this.miniMap.length;d++)for(let c=0;c<this.miniMap[d].length;c++){const p=this.miniMap[d][c];let u="black";p===0&&(u="#2e2d2d"),((f=I())==null?void 0:f.id)===p&&(u="gray");const r=(c-d)*(e/2)+n,a=(c+d)*(i/2)+h;this.ctx.fillStyle=u,this.ctx.beginPath(),this.ctx.moveTo(r,a),this.ctx.lineTo(r+e/2,a+i/2),this.ctx.lineTo(r,a+i),this.ctx.lineTo(r-e/2,a+i/2),this.ctx.closePath(),this.ctx.fill()}}render(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.tileMap.render(this.ctx),this.entities.render(this.ctx,this.tileMap.tileWidth,this.tileMap.tileHeight),this.renderMiniMap(),this.transitionEffect.active&&(this.ctx.fillStyle=`rgba(0, 0, 0, ${this.transitionEffect.alpha})`,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height))}}async function O(l){const t={},o=Object.entries(l).map(([s,e])=>new Promise((i,n)=>{const h=new Image;h.src=e,h.onload=()=>{t[s]=h,i()},h.onerror=()=>n(`Failed to load image: ${e}`)}));return await Promise.all(o),t}async function ot(){const l=await O(nt),t=await O(rt),o=await O(at),s=await O(ht);return{tiles:l,rocks:t,player:o,doors:s}}const nt={grass1:"assets/tiles/grass1.png",grass2:"assets/tiles/grass2.png",grass3:"assets/tiles/grass3.png",edgeLeft:"assets/tiles/edgeLeft.png",edgeTopLeft:"assets/tiles/edgeTopLeft.png",edgeRight:"assets/tiles/edgeRight.png",edgeTopRight:"assets/tiles/edgeTopRight.png",edgeCenter:"assets/tiles/edgeCenter.png"},rt={rock1:"assets/obstacles/rock1.png"},at={player_up:"assets/player/Character_Up.png",player_upleft:"assets/player/Character_UpLeft.png",player_upright:"assets/player/Character_UpRight.png",player_down:"assets/player/Character_Down.png",player_downleft:"assets/player/Character_DownLeft.png",player_downright:"assets/player/Character_DownRight.png",player_left:"assets/player/Character_Left.png",player_right:"assets/player/Character_Right.png"},ht={door_upleft:"assets/doors/upleft.png",door_upright:"assets/doors/upright.png",door_downleft:"assets/doors/downleft.png",door_downright:"assets/doors/downright.png"},R=document.createElement("canvas"),_=800,W=600;R.width=_;R.height=W;R.style.position="relative";R.style.imageRendering="pixelated";function F(){const l=Math.min(window.innerWidth/_,window.innerHeight/W);R.style.width=`${_*l}px`,R.style.height=`${W*l}px`}F();window.addEventListener("resize",F);const L=document.getElementById("board");L==null||L.appendChild(R);const U=R.getContext("2d");if(!U)throw new Error("Canvas context not available");ot().then(l=>{new st(U,l).start()});
